<html>
	<head>
		<title>Jerry</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
			a {font-size: 100px;color:blue;}
		</style>
	</head>
	<body>
	      <video id="videoSource" muted autoplay width="240px" height="200px"></video>
	      <a id="Catch"></a>
	      <a id="distanceRemained"></a>
	      	</body>
		<script src="js/vendor/three.min.js"></script>
		<script src="js/vendor/THREEx.KeyboardState.js"></script>
		<script src="js/vendor/clmtrackr.js"></script>
		<script src="js/vendor/camera.js"></script>		
		<script src="js/vendor/model_pca_20_svm.js"></script>
		<script src="js/vendor/OrbitControls.js"></script>
		<script src="/socket.io/socket.io.js"></script>

		<script src="js/initScene.js"></script>
		<script src="js/mechanic.js"></script>
		<script>



			//CAMERA
			camera.rotation.y=180 * Math.PI / 180;




			//CONTROLS
			// var controls = new THREE.OrbitControls( camera );
			socket.emit('reset');
		

			//var keyboard = new THREEx.KeyboardState();
    		

    		var faceDetection = function(){
    			var positions = ctracker.getCurrentPosition();
    			aPos=positions[33];
    		}

			var updateJerry = function(){

				if (Math.abs(tom.position.z-jerry.position.z)>disBetTandJ){
					jerry.position.z=tom.position.z-disBetTandJ-0.01;
				}


				faceDetection();
				jerry.position.z +=jerrySpeed;
				if(aPos){
					 shift= jerryMetaShift*(aPos[0]-120)/1200; //120~-120
					// camera.position.x = 20*((240-aPos[0])/240-0.5); //10- -10
				}
				jerry.position.x +=shift;
				jerry.position.x = Math.max(jerry.position.x,-groundWidth/2);
				jerry.position.x = Math.min(jerry.position.x,groundWidth/2);
				socket.emit('jerry', {'x': jerry.position.x, 'y': jerry.position.y, 'z': jerry.position.z});
			}

			var updateTom = function(){
				// var step=0.3
				// if(tom.position.x>jerry.position.x)
				// tom.position.x -=step;
				// else tom.position.x+=step;
			}

			


			var updateCube0 = function(){
				cube0.position.z=jerry.position.z+500;
			}

			socket.emit('reset');
			
			socket.on('tom', function(data){
				tom.position.x=data.x;
				tom.position.y=data.y;
				tom.position.z=data.z;
			});

			socket.on('tomCatchedJerry',function(){
					reset();
					alert('You lose!! You have been catched!!');
					

			});			
			socket.on('jerryGotTheFood',function(){
					reset();
						alert('Yay, you win!! You got the food!!');
						

			});
			socket.on('jerryMissedTheFood',function(){
				reset();
						alert('You lose!! You missed the food!!');
						
			});

			var render = function () {

				updateJerry();

				// if(isHit(jerry,tom)){

				// }

				// if((food.position.z-jerry.position.z)<cubeSize*3) {
				// 	if(isHit(jerry,food)){

				// 	}
				// 	else{

				// 	}
				// };
				
				updateTom();
				setCamera(jerry.position.x,jerry.position.y,jerry.position.z);
				updateDistanceRemained();
				updateJerrySpeed();
				renderer.render(scene, camera);
			};

			function animate() {

				requestAnimationFrame( animate );

				render();

			}
			animate();
		</script>

</html>


