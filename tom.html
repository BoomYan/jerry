<html>
	<head>
		<title>Tom</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
			a {font-size: 80px;color:blue;}
			#videoSource{
				/*display: none;*/

    			transform: rotateY(180deg);
    			-webkit-transform:rotateY(180deg); /* Safari and Chrome */
    			-moz-transform:rotateY(180deg); /* Firefox */
			}
			
		</style>
	</head>
	<body>
	      <video id="videoSource" muted autoplay width="240px" height="200px"></video>
	      <a id="Catch"></a>
	      <a id="distanceRemained"></a>
	      	</body>
		<script src="js/vendor/three.min.js"></script>
		<script src="js/vendor/THREEx.KeyboardState.js"></script>
		<script src="js/vendor/clmtrackr.js"></script>

		<script src="js/vendor/camera.js"></script>	
		<script src="js/vendor/model_pca_20_svm.js"></script>
		<script src="js/vendor/OrbitControls.js"></script>
		<script src="/socket.io/socket.io.js"></script>

		<script src="js/initScene.js"></script>
		<script src="js/mechanic.js"></script>
		<script>








			// var resetPosition = function(){
			// 	jerry.position.z =-5;
			// 	jerry.position.x = (Math.random()-0.5)*groundWidth;
						
			// }

			// resetPosition();


			//CONTROLS
			var controls = new THREE.OrbitControls( camera );
			// controls.addEventListener( 'change', render );


    		
    		var faceDetection = function(){
    			var positions = ctracker.getCurrentPosition();
    			aPos=positions[33];
    		}

			var emitTom = function(){
				socket.emit('tom', {'x': tom.position.x, 'y': tom.position.y, 'z': tom.position.z});				
			}

			var updateJerry = function(){
				// jerry.position.z +=jerrySpeed;
			}


			var updateTom = function(){

				 // if(keyboard.pressed("left")) tom.position.x -= 0.05;
				 // if(keyboard.pressed("right")) tom.position.x += 0.05;


				faceDetection();
				if(aPos){
					 shift= tomMetaShift*(aPos[0]-120)/1200; //120~-120
					// camera.position.x = 20*((240-aPos[0])/240-0.5); //10- -10
				}
				tom.position.x -=shift;
				tom.position.x = Math.max(tom.position.x,-groundWidth/2);
				tom.position.x = Math.min(tom.position.x,groundWidth/2);
				emitTom();

			}





			var updateCube0 = function(){
				cube0.position.z=tom.position.z-500;
			}

			socket.emit('reset');

			socket.on('jerry', function(data){
					//console.log('received jerry socket');
				jerry.position.x=data.x;
				jerry.position.y=data.y;
				jerry.position.z=data.z;
			});
			socket.on('tomCatchedJerry',function(){
				reset();
				alert('Yay, you win!! You catched the rat!!');


			});			
			socket.on('jerryGotTheFood',function(){
				reset();
				alert('You lose!! Jerry got the food!!');


			});
			socket.on('jerryMissedTheFood',function(){
				reset();
				alert('Yay, you win!! Jerry missed the food!!');
				
			});


			var render = function () {

				//updateJerry();

				// if((tom.position.z-jerry.position.z)<cubeSize) {
				// 	isCatched();
				// 	//resetJerry();
				// 	nextTom();
				// 	updateCube0();
				// };
				if(isHit(jerry,tom)){


					socket.emit('tomCatchedJerry');
					return;
					// reset();
				}

				if((food.position.z-jerry.position.z)<cubeSize*3) {
					if(isHit(jerry,food)){
						socket.emit('jerryGotTheFood');
						return;
						// reset();
					}
					else{

						socket.emit('jerryMissedTheFood');
						return;	
						// reset();
					}
				};

				if((tom.position.z-jerry.position.z)<cubeSize) {
					nextTom();
					updateCube0();
				};				

				updateTom();
				setCamera(tom.position.x,tom.position.y,tom.position.z);
				updateDistanceRemained();
				updateJerrySpeed();
				// controls.update;
				renderer.render(scene, camera);
			};

			function animate() {

				requestAnimationFrame( animate );

				render();

			}

			animate();

		</script>
</html>


